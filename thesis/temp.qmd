---
title: ""
format: 
  pdf:
    include-in-header:
      text: |
        <!-- \usepackage{amsmath} -->
        <!-- \usepackage{mathspec} -->
        \usepackage{algorithm}
        \usepackage{algpseudocode}
        \usepackage[colorlinks=true, linkcolor=blue, citecolor=blue, urlcolor=blue]{hyperref}
        \usepackage{array}
    mathspec: true
    number-sections: true
link-citations: true
execute:
  cache: false
  echo: false
  warning: false
bibliography: D:/Github/Recon_Honours_Thesis/references.bib
# bibliographystyle: apa
csl: D:/Github/Recon_Honours_Thesis/apa.csl
editor_options: 
  chunk_output_type: console
---


```{r library}
library(ggplot2)
library(patchwork)
library(dplyr)
library(tidyr)
library(fable)
library(fabletools)
library(feasts)
library(tsibble)
library(lubridate)
library(knitr)
library(kableExtra)
library(stringr)
library(forcats)

library(ReconCov)

path <- "D:/Github/Recon_Honours_Thesis/"
knitr::opts_knit$set(root.dir = path)
# setwd(path)
```


# Forecasting Australian Domestics Tourism {#sec-empirical}

```{r}
tourism_plots <- readRDS("literature/tourism_plots.rds")
```

Domestic tourism flows in Australia exhibit a natural hierarchical and grouped structure, driven both by geography and by purpose of travel. At the top of this hierarchy lies the national total, which splits into the seven states and territories. Each state is further sub-divided into tourism zones, which in turn break down into 77 regions. A complete illustration of this geographic hierarchy appears in Appendix @sec-tourism-supplement. Intersecting this geographic hierarchy is a second dimension--travel motive--partitioning tourism flows into four categories: holiday, business, visiting friends and relatives, and other. Altogether, this yields a grouped system of 560 series, from the most disaggregated regional-purpose cells up to the full national aggregate. @tbl-tourism-structure depicts this structure.

```{r}
#| tbl-cap: "Hierarchical and grouped structure of Australian domestic tourism flows"
#| label: tbl-tourism-structure

num_series_geo <- c(1, 7, 27, 77)
table_structure <- tibble(
  `Geographical division` = c("Australia", "States", "Zones", "Regions"),
  `Number of series per geographical division` = num_series_geo,
  `Number of series per purpose` = 4*num_series_geo,
  `Total number of series` = 5*num_series_geo
)
# add total per row
table_structure <- rbind(
  table_structure,
  c("Total", colSums(table_structure[,-1]))
)

# width margin smaller (90%)
table_structure |> 
  knitr::kable(
    align = "lccc",
    booktabs = TRUE
  )
```

We quantify tourism demand via "visitor nights", the total number of nights spent by Australians away from home. The data is collected via the National Visitor Survey, managed by Tourism Research Australia, using computer assisted telephone interviews from nearly 120,000 Australian residents aged 15 years and over [@tourism-au].

The data are monthly time series spanning from January 1998 to December 2016, resulting in 228 observations per series, producing a canonical "$n \ll p$" setting which is ideal for evaluating reconciliation approaches that rely on high-dimensional covariance estimation. The extreme dimensionality over sample size mirrors many contemporary business problems, for instance, Starbucks drink sales. Tourism demand is also economically vital yet highly volatile, with geographical and purpose‑specific patterns create a realistic stress‑test for reconciliation algorithms. 

<!-- Consequently, this panel offers both a rich policy case study and a stringent statistical laboratory for comparing reconciliation strategies that exploit cross-series information to improve forecasts when historical data are scarce. -->

<!-- This dataset is particularly well‑suited to evaluating forecast‑reconciliation methods for three reasons. First, tourism demand is economically important and notoriously volatile; the heterogeneous regional and purpose‑specific patterns create a realistic stress‑test for reconciliation algorithms. Second, the clear structural shift towards stronger growth after 2016—visible in most aggregates—necessitates techniques capable of handling possible breaks or time‑varying error structures, making the exercise practically relevant. Third, the extreme dimensionality relative to sample size mirrors many contemporary business problems (e.g., SKU‑level retail sales), allowing insights to generalise beyond tourism. Using this panel therefore provides both a compelling policy context and a stringent statistical laboratory for comparing alternative reconciliation strategies, especially those that rely on regularised covariance estimation or exploit cross‑sectional information to stabilise forecasts when historical data are scant. -->

@Wickramasuriya2019-xq also argued that modelling spatial autocorrelations directly from the start would be challenging as in this case of a large collection of time series. Post-processing reconciliation approaches have the advantage to implicitly model this spatial autocorrelation structure, especially true for MinT.

To assess forecasting performance, we adopt a rolling-window cross-validation scheme. Beginning with the first 120 monthly observations (January 1998-December 2005) as the initial training set, we obtain the best-fitted ARIMA model for each of the 560 series via the automatic algorithm by minimising AICc from @Hyndman2008-rf. The 1- to 12-step-ahead base forecasts are then generated by these ARIMA models, and then reconciled using multiple approaches. We then roll the training window forward by one month and refit all models, rebuild reconciliations, and produce another batch of 1- to 12-step-ahead forecasts, repeating until the training set reaches December 2015. In total, this results in 133 out-of-sample windows.

<!-- 
Should MinT-sample be included in the paper?

Note that the number of series is larger than the number of observations (560 compared to 96), hence the sample covariance matrix is not positive definite and will not be considered.
-->

```{r}
#| label: fig-tourism-MSE-line
#| fig.height: 6
#| fig.width: 8
#| fig-cap: "Percentage relative improvement in the mean squared error (MSE) of different reconciled forecasts over the base forecasts for the Australian domestic tourism data, for 1 to 12 steps ahead forecasts. The positive entries indicate an decrease in MSE."
tourism_plots$MSE_line + 
  labs(title = NULL, subtitle = NULL) + 
  theme(
    legend.position = "bottom", 
    legend.direction = "vertical", 
    legend.title.position = "left"
  ) + 
  scale_x_continuous(breaks = c(1:12), minor_breaks = NULL)
```

```{r}
#| label: fig-tourism-MSE-heat
#| fig.height: 5
#| fig.width: 7
#| out.width: "90%"
#| fig-cap: "Heatmap of relative improvement in the mean squared error (MSE) of different reconciled forecasts over the base forecasts for the Australian domestic tourism data, for 1 to 12 steps ahead forecasts. The values are scaled to the range of 0 to 100 for better visualisation, with darker colors indicating greater improvement and best performance is noted by a star."

tourism_plots$MSE_heat + 
  labs(title = NULL, subtitle = NULL) + 
  theme(legend.title = element_blank(), legend.position = "bottom") + 
  scale_x_continuous(breaks = c(1:12), minor_breaks = NULL)
```


@fig-tourism-MSE-line and @fig-tourism-MSE-heat show that reconciliation is beneficial for point forecasts: across horizons $h=1,2,\dots,12$, all reconciled methods improve MSE over incoherent base ARIMA on average. Among vanilla MinT variants, the shrinkage estimator (*MinT-S*) marginally outperforms NOVELIST (*MinT-N*) at most horizons, though the gap is small. Adjusting for a single dominant factor via PC decomposition tightens performance further: both *MinT-S(PC1)* and *MinT-N(PC1)* beat their unadjusted counterparts, with *MinT-N(PC1)* narrowly ahead. Adding more than one PC brings no additional benefit, likely due to injecting estimation noise from weaker components. Variants that modify the multi-step covariance, either via scaled-variance or direct h-step residual covariances, underperform standard MinT, suggesting that extra estimation at horizon $h>1$ is not rewarded in this setting.


```{r}
#| label: fig-tourism-probscores
#| fig.height: 12
#| fig.width: 12
#| fig-cap: "Percentage relative improvement in the Winkler score at 80% and 95% nominal coverage, CRPS, and Energy score of multiple reconciled forecasts over the base forecasts for the Australian domestic tourism data, for 1-step-ahead forecasts. The positive entries indicate an decrease in the probabilistic scores."

# a 2x2 showing 4 plots showing the 1-step-ahead % improv in Winkler score 80, 95, CRPS, and Energy

tourism_plots$W80 + labs(title = "Winkler score 80%", subtitle = NULL) + 
  tourism_plots$W95 + labs(title = "Winkler score 95%", subtitle = NULL) +
  tourism_plots$CRPS + labs(title = "CRPS", subtitle = NULL) +
  tourism_plots$Energy + labs(title = "Energy score", subtitle = NULL) +
  plot_layout(ncol = 2, guides = "collect", axis_titles = "collect") & 
  theme(legend.position = "bottom", legend.title = element_blank())

```


Turning to probabilistic forecasts (1-step-ahead forecasts), @fig-tourism-probscores shows that *MinT-N* consistently outperforms *MinT-S* across CRPS and both Winkler scores, and PC1-adjustment again yields the best improvements. Results are aligned across probabilistic scoring rules, but the 95% Winkler reveals a notable pattern, as all MinT variants lose to the base while *OLS* performs best. In the multivariate evaluation, the Energy score places *OLS* close to the PC1-adjusted MinT methods, indicating that simple coherent projection might be able to capture a substantial share of cross-series dependence benefits even without sophisticated covariance regularisation.

\color{red}
Discuss the 95% empirical coverage 
\color{black}

The summary radar graph in @fig-tourism-radar consolidates these findings: among the selected MinT models by probabilistic criteria, *MinT-N(PC1)* clearly leads across CRPS, W80, W95, and Energy, extending the improvements seen in the single-metric panels. 

Taken together, the evidence supports the use of reconciliation for both point and probabilistic forecasts in this high-dimensional setting. For point forecasts, MinT with shrinkage is a solid default; for probabilistic forecasts, NOVELIST performs more reliably. PC adjustment with a single dominant factor consistently enhances performance and should be considered when a dominant latent factor is evident. More complex adjustments, such as multiple PCs or horizon-specific covariances, add estimation noise without clear benefits and can be omitted for parsimony.


```{r}
#| label: fig-tourism-radar
#| fig.height: 8
#| fig.width: 8
#| out.width: "90%"
#| fig-cap: "Radar plot of relative improvements in probabilistic scores (Winkler 80, Winkler 95, CRPS, Energy) over the base forecasts. The scores are scaled to a range of 0 to 100, with larger values indicating better performance. Only the top 5 models are shown."


# a radar plot of 5 top models based on probabilistic scores (Winkler 80, 95, CRPS, Energy) scaled to 0-100 
par(mfrow=c(1,1), mar=c(0,0,0,0))
tourism_plots$radar
```


\pagebreak

# Appendix {#sec-appendix}

## Appendix: Australian Domestic Tourism Geographical Hierarchy {#sec-tourism-supplement}

```{r}
#| tbl-cap: "Geographical divisions of Australia."
#| label: tbl-tourism-geo
#| warning: false
#| message: false

source(paste0(path, "R/table_geo.R"))
table_geo_labeled <- create_table_geo()
table_geo_labeled[1,1] <- "Total"

df <- table_geo_labeled %>% 
  select(Series, Name, Label)

n  <- ceiling(nrow(df) / 2)
L  <- df[1:n, ]
R  <- df[(n+1):nrow(df), ]

# pad the shorter side
if (nrow(R) < nrow(L)) {
  R <- bind_rows(R, tibble(Series = rep(NA_integer_, n - nrow(R)),
                           Name = "", Label = ""))
}

wide <- bind_cols(
  setNames(L, c("Series","Name","Label")),
  setNames(R, c("Series","Name","Label"))
)

kable(
  wide,
  align     = c("r","l","l","r","l","l"),
  col.names = c("Series","Name","Label","Series","Name","Label")
) |> 
  kable_styling(latex_options = "hold_position", font_size = 8)
```
